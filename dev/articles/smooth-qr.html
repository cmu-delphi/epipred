<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="epipredict">
<title>Smooth quantile regression â€¢ epipredict</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Smooth quantile regression">
<meta property="og:description" content="epipredict">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-primary" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">epipredict</a>

    <small class="nav-text text-success me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.0.15</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/epipredict.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/preprocessing-and-models.html">Examples of Preprocessing and Models</a>
    <a class="dropdown-item" href="../articles/arx-classifier.html">Auto-regressive classifier</a>
    <a class="dropdown-item" href="../articles/update.html">Using the add/update/remove and adjust functions</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/cmu-delphi/epipredict/tree/main/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Smooth quantile regression</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epipredict/blob/main/vignettes/articles/smooth-qr.Rmd" class="external-link"><code>vignettes/articles/smooth-qr.Rmd</code></a></small>
      <div class="d-none name"><code>smooth-qr.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introducing-smooth-quantile-regression">Introducing smooth quantile regression<a class="anchor" aria-label="anchor" href="#introducing-smooth-quantile-regression"></a>
</h2>
<p>Whereas other time-series forecasting examples in this package have
used (direct) models for single horizons, in multi-period forecasting,
the goal is to (directly) forecast several horizons simultaneously. This
is useful in epidemiological applications where decisions are based on
the trend of a signal.</p>
<p>The idea underlying smooth quantile regression is that set forecast
targets can be approximated by a smooth curve. This novel approach from
<a href="https://arxiv.org/abs/2202.09723" class="external-link">Tuzhilina et al., 2022</a>
enforces smoothness across the horizons and can be applied to point
estimation by regression or interval prediction by quantile regression.
Our focus in this vignette is the latter.</p>
</div>
<div class="section level2">
<h2 id="built-in-function-for-smooth-quantile-regression-and-its-parameters">Built-in function for smooth quantile regression and its
parameters<a class="anchor" aria-label="anchor" href="#built-in-function-for-smooth-quantile-regression-and-its-parameters"></a>
</h2>
<p>The built-in smooth quantile regression function,
<code><a href="../reference/smooth_quantile_reg.html">smooth_quantile_reg()</a></code> provides a model specification for
smooth quantile regression that works under the tidymodels framework. It
has the following parameters and default values:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/smooth_quantile_reg.html">smooth_quantile_reg</a></span><span class="op">(</span></span>
<span>  mode <span class="op">=</span> <span class="st">"regression"</span>,</span>
<span>  engine <span class="op">=</span> <span class="st">"smoothqr"</span>,</span>
<span>  outcome_locations <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  quantile_levels <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  degree <span class="op">=</span> <span class="fl">3L</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For smooth quantile regression, the type of model or
<code>mode</code> is regression.</p>
<p>The only <code>engine</code> that is currently supported is
<code>smooth_qr()</code> from the <a href="https://dajmcdon.github.io/smoothqr/" class="external-link"><code>smoothqr</code>
package</a>.</p>
<p>The <code>outcome_locations</code> indicate the multiple horizon (ie.
ahead) values. These should be specified by the user.</p>
<p>The <code>quantile_levels</code> parameter is a vector of values that
indicates the quantiles to be estimated. The default is the median (0.5
quantile).</p>
<p>The <code>degree</code> parameter indicates the degree of the
polynomials used for smoothing of the response. It should be no more
than the number of aheads. If the degree is precisely equal to the
number of aheads, then there is no smoothing. To better understand this
parameter and how it works, we should look to its origins and how it is
used in the model.</p>
</div>
<div class="section level2">
<h2 id="model-form">Model form<a class="anchor" aria-label="anchor" href="#model-form"></a>
</h2>
<p>Smooth quantile regression is linear auto-regressive, with the key
feature being a transformation that forces the coefficients to satisfy a
smoothing constraint. The purpose of this is for each model coefficient
to be a smooth function of ahead values, and so each such coefficient is
set to be a linear combination of smooth basis functions (such as a
spline or a polynomial).</p>
<p>The <code>degree</code> parameter controls the number of these
polynomials used. It should be no greater than the number of responses.
This is a tuning parameter, and so it can be chosen by performing a grid
search with cross-validation. Intuitively, <span class="math inline">\(d
= 1\)</span> corresponds to the constant model, <span class="math inline">\(d = 2\)</span> gives straight line forecasts,
while <span class="math inline">\(d = 3\)</span> gives quadratic
forecasts. Since a degree of 3 was found to work well in the tested
applications (see Section 9 of <a href="https://arxiv.org/abs/2202.09723" class="external-link">Tuzhilina et al., 2022</a>), it
is the default value.</p>
</div>
<div class="section level2">
<h2 id="demonstration-of-smooth-quantile-regression">Demonstration of smooth quantile regression<a class="anchor" aria-label="anchor" href="#demonstration-of-smooth-quantile-regression"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will now apply smooth quantile regression on the real data used
for COVID-19 forecasting. The built-in dataset we will use is a subset
of JHU daily data on state cases and deaths. This sample data ranges
from Dec.Â 31, 2020 to Dec.Â 31, 2021.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">edf</span> <span class="op">&lt;-</span> <span class="va">case_death_rate_subset</span></span></code></pre></div>
<p>We will set the forecast date to be November 30, 2021 so that we can
produce forecasts for target dates of 1 to 28 days ahead. We construct
our test data, <code>tedf</code> from the days beyond this.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-11-30"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tedf</span> <span class="op">&lt;-</span> <span class="va">edf</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">&gt;=</span> <span class="va">fd</span><span class="op">)</span></span></code></pre></div>
<p>We will use the most recent 3 months worth of data up to the forecast
date for training.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">edf</span> <span class="op">&lt;-</span> <span class="va">edf</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">&lt;</span> <span class="va">fd</span>, <span class="va">time_value</span> <span class="op">&gt;=</span> <span class="va">fd</span> <span class="op">-</span> <span class="fl">90L</span><span class="op">)</span></span></code></pre></div>
<p>And for plotting our focus will be on a subset of two states -
California and Utah.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ut"</span>, <span class="st">"ca"</span><span class="op">)</span></span></code></pre></div>
<p>Suppose that our goal with this data is to predict COVID-19 death
rates at several horizons for each state. On day <span class="math inline">\(t\)</span>, we want to predict new deaths <span class="math inline">\(y\)</span> that are <span class="math inline">\(a
= 1,\dots, 28\)</span> days ahead at locations <span class="math inline">\(j\)</span> using the death rates from today, 1
week ago, and 2 weeks ago. So for each location, weâ€™ll predict the
median (0.5 quantile) for each of the target dates by using <span class="math display">\[
\hat{y}_{j}(t+a) = \alpha(a) + \sum_{l = 0}^2 \beta_{l}(a)  y_{j}(t -
7l)
\]</span> where <span class="math inline">\(\beta_{l}(a) = \sum_{i=1}^d
\theta_{il} h_i(a)\)</span> is the smoothing constraint where <span class="math inline">\({h_1(a), \dots, h_d(a)}\)</span> are the set of
smooth basis functions and <span class="math inline">\(d\)</span> is a
hyperparameter that manages the flexibility of <span class="math inline">\(\beta_{l}(a)\)</span>. Remember that the goal is
to have each <span class="math inline">\(\beta_{l}(a)\)</span> to be a
smooth function of the aheads and that is achieved through imposing the
smoothing constraint.</p>
<p>Note that this model is intended to be simple and straightforward.
Our only modification to this model is to add case rates as another
predictive feature (we will leave it to the reader to incorporate
additional features beyond this and the historical response values). We
can update the basic model incorporate the <span class="math inline">\(k
= 2\)</span> predictive features of case and death rates for each
location j, <span class="math inline">\(x_j(t) = (x_{j1}(t),
x_{j2}(t))\)</span> as follows:</p>
<p><span class="math display">\[
\hat{y}_{j}(t+a) = \alpha(a) + \sum_{k = 1}^2 \sum_{l = 0}^2
\beta_{kl}(a)  x_{jk}(t - 7l)
\]</span> where <span class="math inline">\(\beta_{kl}(a) = \sum_{i=1}^d
\theta_{ikl} h_i(a)\)</span>.</p>
<p>Now, we will create our own forecaster from scratch by building up an
<code>epi_workflow</code> (there is no canned forecaster that is
currently available). Building our own forecaster allows for
customization and control over the pre-processing and post-processing
actions we wish to take.</p>
<p>The pre-processing steps we take in our <code>epi_recipe</code> are
simply to lag the predictor (by 0, 7, and 14 days) and lead the response
by the multiple aheads specified by the function user.</p>
<p>The post-processing layers we add to our <code>frosting</code> are
nearly as simple. We first predict, unnest the prediction list-cols,
omit NAs from them, and enforce that they are greater than 0.</p>
<p>The third component of an to an <code>epi_workflow</code>, the model,
is smooth quantile regression, which has three main arguments - the
quantiles, aheads, and degree.</p>
<p>After creating our <code>epi_workflow</code> with these components,
we get our test data based on longest lag period and make the
predictions.</p>
<p>We input our forecaster into a function for ease of use.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smooth_fc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">aheads</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">28</span>, <span class="va">degree</span> <span class="op">=</span> <span class="fl">3L</span>, <span class="va">quantiles</span> <span class="op">=</span> <span class="fl">0.5</span>, <span class="va">fd</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">case_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">death_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">death_rate</span>, ahead <span class="op">=</span> <span class="va">aheads</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/frosting.html">frosting</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/layer_predict.html">layer_predict</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/layer_unnest.html">layer_unnest</a></span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/layer_naomit.html">layer_naomit</a></span><span class="op">(</span><span class="va">distn</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/layer_add_forecast_date.html">layer_add_forecast_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/layer_threshold.html">layer_threshold</a></span><span class="op">(</span><span class="va">distn</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">ee</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_quantile_reg.html">smooth_quantile_reg</a></span><span class="op">(</span></span>
<span>    quantile_levels <span class="op">=</span> <span class="va">quantiles</span>,</span>
<span>    outcome_locations <span class="op">=</span> <span class="va">aheads</span>,</span>
<span>    degree <span class="op">=</span> <span class="va">degree</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">ewf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="va">rec</span>, <span class="va">ee</span>, <span class="va">f</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">the_fit</span> <span class="op">&lt;-</span> <span class="va">ewf</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_test_data.html">get_test_data</a></span><span class="op">(</span><span class="va">rec</span>, <span class="va">x</span>, fill_locf <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">the_fit</span>, new_data <span class="op">=</span> <span class="va">latest</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>forecast_date <span class="op">=</span> <span class="va">fd</span>, target_date <span class="op">=</span> <span class="va">fd</span> <span class="op">+</span> <span class="va">ahead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">target_date</span>, <span class="va">distn</span>, <span class="va">ahead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/pivot_quantiles_wider.html">pivot_quantiles_wider</a></span><span class="op">(</span><span class="va">distn</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">preds</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Notice that we allow the function user to specify the aheads, degree,
and quantile as they may want to change these parameter values. We also
allow for input of the forecast date as we fixed that at the onset of
this demonstration.</p>
<p>We now can produce smooth quantile regression predictions for our
problem:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smooth_preds</span> <span class="op">&lt;-</span> <span class="fu">smooth_fc</span><span class="op">(</span><span class="va">edf</span>, fd <span class="op">=</span> <span class="va">fd</span><span class="op">)</span></span>
<span></span>
<span><span class="va">smooth_preds</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,568 Ã— 4</span></span></span>
<span><span class="co">#&gt;    geo_value target_date ahead `0.5`</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> ak        2021-12-01      1 0.323</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> ak        2021-12-02      2 0.347</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> ak        2021-12-03      3 0.369</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> ak        2021-12-04      4 0.389</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> ak        2021-12-05      5 0.407</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> ak        2021-12-06      6 0.422</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> ak        2021-12-07      7 0.436</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> ak        2021-12-08      8 0.448</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> ak        2021-12-09      9 0.458</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> ak        2021-12-10     10 0.465</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 1,558 more rows</span></span></span></code></pre>
<p>Most often, weâ€™re not going to want to limit ourselves to just
predicting the median value as there is uncertainty about the
predictions, so letâ€™s try to predict several different quantiles in
addition to the median:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">several_quantiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">.25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>, <span class="fl">.9</span><span class="op">)</span></span>
<span><span class="va">smooth_preds</span> <span class="op">&lt;-</span> <span class="fu">smooth_fc</span><span class="op">(</span><span class="va">edf</span>, quantiles <span class="op">=</span> <span class="va">several_quantiles</span>, fd <span class="op">=</span> <span class="va">fd</span><span class="op">)</span></span>
<span></span>
<span><span class="va">smooth_preds</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,568 Ã— 8</span></span></span>
<span><span class="co">#&gt;    geo_value target_date ahead `0.1` `0.25` `0.5` `0.75` `0.9`</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> ak        2021-12-01      1 0.286  0.315 0.323  0.350 0.434</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> ak        2021-12-02      2 0.292  0.331 0.347  0.383 0.474</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> ak        2021-12-03      3 0.298  0.345 0.369  0.414 0.511</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> ak        2021-12-04      4 0.303  0.358 0.389  0.442 0.544</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> ak        2021-12-05      5 0.307  0.369 0.407  0.467 0.575</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> ak        2021-12-06      6 0.310  0.378 0.422  0.490 0.603</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> ak        2021-12-07      7 0.313  0.387 0.436  0.511 0.629</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> ak        2021-12-08      8 0.314  0.393 0.448  0.529 0.651</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> ak        2021-12-09      9 0.315  0.398 0.458  0.544 0.670</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> ak        2021-12-10     10 0.315  0.402 0.465  0.557 0.687</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 1,558 more rows</span></span></span></code></pre>
<p>We can see that we have different columns for the different quantile
predictions.</p>
<p>Letâ€™s visualize these results for the sample of two states. We will
create a simple plotting function, under which the median predictions
are an orange line and the surrounding quantiles are blue bands around
this. For comparison, we will include the actual values over time as a
black line.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_preds</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">preds</span>, <span class="va">geos_to_plot</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">train_test_dat</span>, <span class="va">fd</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">geos_to_plot</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">preds</span> <span class="op">&lt;-</span> <span class="va">preds</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">geos_to_plot</span><span class="op">)</span></span>
<span>    <span class="va">train_test_dat</span> <span class="op">&lt;-</span> <span class="va">train_test_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">geos_to_plot</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">target_date</span>, ymin <span class="op">=</span> <span class="va">`0.1`</span>, ymax <span class="op">=</span> <span class="va">`0.9`</span><span class="op">)</span>,</span>
<span>      fill <span class="op">=</span> <span class="st">"cornflowerblue"</span>, alpha <span class="op">=</span> <span class="fl">.8</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">target_date</span>, ymin <span class="op">=</span> <span class="va">`0.25`</span>, ymax <span class="op">=</span> <span class="va">`0.75`</span><span class="op">)</span>,</span>
<span>      fill <span class="op">=</span> <span class="st">"#00488E"</span>, alpha <span class="op">=</span> <span class="fl">.8</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">train_test_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">death_rate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">target_date</span>, <span class="va">`0.5`</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">fd</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">geo_value</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">""</span>, date_labels <span class="op">=</span> <span class="st">"%b %Y"</span>, date_breaks <span class="op">=</span> <span class="st">"2 months"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Deaths per 100K inhabitants"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Since we would like to plot the actual death rates for these states
over time, we bind the training and testing data together and input this
into our plotting function as follows:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_preds</span><span class="op">(</span><span class="va">smooth_preds</span>, <span class="va">geos</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">tedf</span>, <span class="va">edf</span><span class="op">)</span>, <span class="va">fd</span><span class="op">)</span></span></code></pre></div>
<p><img src="smooth-qr_files/figure-html/unnamed-chunk-11-1.png" width="100%"></p>
<p>We can see that the predictions are smooth curves for each state, as
expected when using smooth quantile regression. In addition while the
curvature of the forecasts matches that of the truth, the forecasts do
not look remarkably accurate.</p>
<div class="section level3">
<h3 id="varying-the-degrees-parameter">Varying the degrees parameter<a class="anchor" aria-label="anchor" href="#varying-the-degrees-parameter"></a>
</h3>
<p>We can test the impact of different degrees by using the
<code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map()</a></code> function. Noting that this may take some time to run,
letâ€™s try out all degrees from 1 to 7:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smooth_preds_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>, <span class="op">~</span> <span class="fu">smooth_fc</span><span class="op">(</span><span class="va">edf</span>,</span>
<span>  degree <span class="op">=</span> <span class="va">.x</span>,</span>
<span>  quantiles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">.25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>, <span class="fl">.9</span><span class="op">)</span>,</span>
<span>  fd <span class="op">=</span> <span class="va">fd</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>degree <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>One way to quantify the impact of these on the forecasting is to look
at the mean absolute error (MAE) or mean squared error (MSE) over the
degrees. We can select the degree that results in the lowest MAE.</p>
<p>Since the MAE compares the predicted values to the actual values, we
will first join the test data to the predicted data for our
comparisons:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tedf_sub</span> <span class="op">&lt;-</span> <span class="va">tedf</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>target_date <span class="op">=</span> <span class="va">time_value</span>, actual <span class="op">=</span> <span class="va">death_rate</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">target_date</span>, <span class="va">actual</span><span class="op">)</span></span></code></pre></div>
<p>And then compute the MAE for each of the degrees:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smooth_preds_df_deg</span> <span class="op">&lt;-</span> <span class="va">smooth_preds_list</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">tedf_sub</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">degree</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">`0.5`</span> <span class="op">-</span> <span class="va">actual</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">error</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Arrange the MAE from smallest to largest</span></span>
<span><span class="va">smooth_preds_df_deg</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 Ã— 2</span></span></span>
<span><span class="co">#&gt;   degree  mean</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      3 0.201</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>      2 0.202</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>      5 0.203</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>      4 0.203</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>      6 0.203</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>      7 0.204</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>      1 0.205</span></span></code></pre>
<p>Instead of just looking at the raw numbers, letâ€™s create a simple
line plot to visualize how the MAE changes over degrees for this
data:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">smooth_preds_df_deg</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">degree</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Degrees of freedom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Mean MAE"</span><span class="op">)</span></span></code></pre></div>
<p><img src="smooth-qr_files/figure-html/unnamed-chunk-15-1.png" width="100%"></p>
<p>We can see that the degree that results in the lowest MAE is 3.
Hence, we could pick this degree for future forecasting work on this
data.</p>
</div>
<div class="section level3">
<h3 id="a-brief-comparison-between-smoothing-and-no-smoothing">A brief comparison between smoothing and no smoothing<a class="anchor" aria-label="anchor" href="#a-brief-comparison-between-smoothing-and-no-smoothing"></a>
</h3>
<p>Now, we will briefly compare the results from using smooth quantile
regression to those obtained without smoothing. The latter approach
amounts to ordinary quantile regression to get predictions for the
intended target date. The main drawback is that it ignores the fact that
the responses all represent the same signal, just for different ahead
values. In contrast, the smooth quantile regression approach utilizes
this information about the data structure - the fact that the aheads in
are not be independent of each other, but that they are naturally
related over time by a smooth curve.</p>
<p>To get the basic quantile regression results we can utilize the
forecaster that weâ€™ve already built. We can simply set the degree to be
the number of ahead values to re-run the code without smoothing.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">baseline_preds</span> <span class="op">&lt;-</span> <span class="fu">smooth_fc</span><span class="op">(</span></span>
<span>  <span class="va">edf</span>,</span>
<span>  degree <span class="op">=</span> <span class="fl">28L</span>, quantiles <span class="op">=</span> <span class="va">several_quantiles</span>, fd <span class="op">=</span> <span class="va">fd</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>And we can produce the corresponding plot to inspect the predictions
obtained under the baseline model:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_preds</span><span class="op">(</span><span class="va">baseline_preds</span>, <span class="va">geos</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">tedf</span>, <span class="va">edf</span><span class="op">)</span>, <span class="va">fd</span><span class="op">)</span></span></code></pre></div>
<p><img src="smooth-qr_files/figure-html/unnamed-chunk-17-1.png" width="100%"></p>
<p>Unlike for smooth quantile regression, the resulting forecasts are
not smooth curves, but rather jagged and irregular in shape.</p>
<p>For a more formal comparison between the two approaches, we could
compare the test performance in terms of accuracy through calculating
either the, MAE or MSE, where the performance measure of choice can be
calculated over over all times and locations for each ahead value</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">baseline_preds_mae_df</span> <span class="op">&lt;-</span> <span class="va">baseline_preds</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">tedf_sub</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ahead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">`0.5`</span> <span class="op">-</span> <span class="va">actual</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">error</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"baseline"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">smooth_preds_mae_df</span> <span class="op">&lt;-</span> <span class="va">smooth_preds</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">tedf_sub</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ahead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">`0.5`</span> <span class="op">-</span> <span class="va">actual</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">error</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"smooth"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds_mae_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">baseline_preds_mae_df</span>, <span class="va">smooth_preds_mae_df</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">preds_mae_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ahead</span>, <span class="va">mean</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Ahead"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Mean MAE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#A69943"</span>, <span class="st">"#063970"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="smooth-qr_files/figure-html/unnamed-chunk-18-1.png" width="100%"></p>
<p>or over all aheads, times, and locations for a single numerical
summary.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">baseline_preds_mae_df</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.2038163</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">smooth_preds_mae_df</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.201258</span></span></code></pre>
<p>The former shows that forecasts for the immediate future and for the
distant future are more inaccurate for both models under consideration.
The latter shows that the smooth quantile regression model and baseline
models perform very similarly overall, with the smooth quantile
regression model only slightly beating the baseline model in terms of
overall average MAE.</p>
<p>One other commonly used metric is the Weighted Interval Score (WIS,
<a href="https://arxiv.org/pdf/2005.12881.pdf" class="external-link">Bracher et al.,
2021</a>), which a scoring rule that is based on the population
quantiles. The point is to score the interval, whereas MAE only
evaluates the accuracy of the point forecast.</p>
<p>Let <span class="math inline">\(F\)</span> be a forecast composed of
predicted quantiles <span class="math inline">\(q_{\tau}\)</span> for
the set of quantile levels <span class="math inline">\(\tau\)</span>.
Then, in terms of the predicted quantiles, the WIS for target variable
<span class="math inline">\(Y\)</span> is represented as follows (<a href="https://www.pnas.org/doi/full/10.1073/pnas.2111453118" class="external-link">McDonald
etal., 2021</a>):</p>
<p><span class="math display">\[
WIS(F, Y) = 2 \sum_{\tau} \phi_{\tau} (Y - q_{\tau})
\]</span> where <span class="math inline">\(\phi_{\tau}(x) = \tau
|x|\)</span> for <span class="math inline">\(x \geq 0\)</span> and<span class="math inline">\(\phi_{\tau}(x) = (1 - \tau) |x|\)</span> for <span class="math inline">\(x &lt; 0\)</span>.</p>
<p>This form is general as it can accommodate both symmetric and
asymmetric quantile levels. If the quantile levels are symmetric, then
we can alternatively express the WIS as a collection of central
prediction intervals (<span class="math inline">\(\ell_{\alpha},
u_{\alpha}\)</span>) parametrized by the exclusion probability <span class="math inline">\(\alpha\)</span>:</p>
<p><span class="math display">\[
WIS(F, Y) =  \sum_{\alpha} \{ (u_{\alpha} - \ell_{\alpha}) + 2 \cdot
\text{dist}(Y, [\ell_{\alpha}, u_{\alpha}]) \}
\]</span> where <span class="math inline">\(\text{dist}(a,S)\)</span> is
the smallest distance between point <span class="math inline">\(a\)</span> and an element of set <span class="math inline">\(S\)</span>.</p>
<p>While we implement the former representation, we mention this form
because it shows the that the score can be decomposed into the addition
of a sharpness component (first term in the summand) and an
under/overprediction component (second term in the summand). This
alternative representation is useful because from it, we more easily see
the major limitation to the WIS, which is that the score tends to
prioritize sharpness (how wide the interval is) relative to coverage (if
the interval contains the truth).</p>
<p>Now, we write a simple function for the first representation of the
score that is compatible with the latest version of
<code>epipredict</code> (adapted from the corresponding function in <a href="https://github.com/dajmcdon/smoothmpf-epipredict" class="external-link">smoothmpf-epipredict</a>).
The inputs for it are the actual and predicted values and the quantile
levels.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wis_dist_quantile</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">actual</span>, <span class="va">values</span>, <span class="va">quantile_levels</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span></span>
<span>    <span class="va">quantile_levels</span> <span class="op">*</span> <span class="op">(</span><span class="va">actual</span> <span class="op">-</span> <span class="va">values</span><span class="op">)</span>,</span>
<span>    <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">quantile_levels</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">values</span> <span class="op">-</span> <span class="va">actual</span><span class="op">)</span>,</span>
<span>    na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next, we apply the <code>wis_dist_quantile</code> function to get a
WIS score for each state on each target date. We then compute the mean
WIS for each ahead value over all of the states. The results for each of
the smooth and baseline forecasters are shown in a similar style line
plot as we chose for MAE:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smooth_preds_wis_df</span> <span class="op">&lt;-</span> <span class="va">smooth_preds</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">tedf_sub</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wis <span class="op">=</span> <span class="fu">wis_dist_quantile</span><span class="op">(</span></span>
<span>    <span class="va">actual</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">`0.1`</span>, <span class="va">`0.25`</span>, <span class="va">`0.5`</span>, <span class="va">`0.75`</span>, <span class="va">`0.9`</span><span class="op">)</span>,</span>
<span>    <span class="va">several_quantiles</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ahead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">wis</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"smooth"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">baseline_preds_wis_df</span> <span class="op">&lt;-</span> <span class="va">baseline_preds</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">tedf_sub</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wis <span class="op">=</span> <span class="fu">wis_dist_quantile</span><span class="op">(</span></span>
<span>    <span class="va">actual</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">`0.1`</span>, <span class="va">`0.25`</span>, <span class="va">`0.5`</span>, <span class="va">`0.75`</span>, <span class="va">`0.9`</span><span class="op">)</span>,</span>
<span>    <span class="va">several_quantiles</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ahead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">wis</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"baseline"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds_wis_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">smooth_preds_wis_df</span>, <span class="va">baseline_preds_wis_df</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">preds_wis_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ahead</span>, <span class="va">mean</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Ahead"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Mean WIS"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#A69943"</span>, <span class="st">"#063970"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="smooth-qr_files/figure-html/unnamed-chunk-21-1.png" width="100%"></p>
<p>The results are consistent with what we saw for MAE: The forecasts
for the near and distant future tend to be inaccurate for both models.
The smooth quantile regression model only slightly outperforms the
baseline model.</p>
<p>Though averaging the WIS score over location and time tends to be the
primary aggregation scheme used in evaluation and model comparisons
(see, for example, <a href="https://www.pnas.org/doi/full/10.1073/pnas.2111453118" class="external-link">McDonald et
al., 2021</a>), we can also obtain a single numerical summary by
averaging over the aheads, times, and locations:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">baseline_preds_wis_df</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.1674422</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">smooth_preds_wis_df</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.1644727</span></span></code></pre>
<p>Overall, both perspectives agree that the smooth quantile regression
model tends to perform only slightly better than the baseline model in
terms of average WIS, illustrating the difficulty of this forecasting
problem.</p>
</div>
</div>
<div class="section level2">
<h2 id="what-weve-learned-in-a-nutshell">What weâ€™ve learned in a nutshell<a class="anchor" aria-label="anchor" href="#what-weve-learned-in-a-nutshell"></a>
</h2>
<p>Smooth quantile regression is used in multi-period forecasting for
predicting several horizons simultaneously with a single smooth curve.
It operates under the key assumption that the future of the response can
be approximated well by a smooth curve.</p>
</div>
<div class="section level2">
<h2 id="attribution">Attribution<a class="anchor" aria-label="anchor" href="#attribution"></a>
</h2>
<p>The information presented on smooth quantile regression is from <a href="https://arxiv.org/abs/2202.09723" class="external-link">Tuzhilina et al., 2022</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel McDonald, Ryan Tibshirani, Logan Brooks, Rachel Lobay.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
