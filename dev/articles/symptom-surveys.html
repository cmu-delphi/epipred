<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Can symptoms surveys improve COVID-19 forecasts? • epipredict</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Can symptoms surveys improve COVID-19 forecasts?">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epipredict</a>

    <small class="nav-text text-success me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.1.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epipredict.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/preprocessing-and-models.html">Examples of Preprocessing and Models</a></li>
    <li><a class="dropdown-item" href="../articles/backtesting.html">Accurately backtesting forecasters</a></li>
    <li><a class="dropdown-item" href="../articles/arx-classifier.html">Auto-regressive classifier</a></li>
    <li><a class="dropdown-item" href="../articles/update.html">Using the add/update/remove and adjust functions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epipredict/tree/main/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Can symptoms surveys improve COVID-19 forecasts?</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epipredict/blob/main/vignettes/articles/symptom-surveys.Rmd" class="external-link"><code>vignettes/articles/symptom-surveys.Rmd</code></a></small>
      <div class="d-none name"><code>symptom-surveys.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>During the COVID-19 pandemic, Delphi ran COVID-19 symptom surveys
through Facebook and Google. In these surveys, millions of people in the
US were asked whether they or the people that they know are experiencing
COVID-like symptoms. This enabled the calculation of a “%
CLI-in-community” signal for counties across the US. This is simply an
estimate of the percentage of people who know someone who is presently
sick with a COVID-like illness.</p>
<p>These surveys were valuable tools for monitoring the pandemic because
they reported daily and not subject to reporting delays that plague
other sources of data.</p>
<p>In this vignette, we will look at whether the % CLI-in-community
indicators from the Facebook and Google surveys improve the accuracy of
short-term forecasts of county-level COVID-19 case rates. The purpose
here is to study and demonstrate the value of the Facebook and Google %
CLI-in-community signals to add predictive power beyond what we can
achieve with simple time series models trained on case rates alone.</p>
<p>Note that this vignette was adapted from the following <a href="https://delphi.cmu.edu/blog/2020/09/21/can-symptoms-surveys-improve-covid-19-forecasts/" class="external-link">Delphi
blog post</a>, with the necessary modifications to enable the use of
<code>epipredict</code>. The results may be different from those on the
blog post (one reason is that we are exploring the use of a different
forecaster and another is that we’re using the most recent versions of
the datasets).</p>
<p>Now, we will delve into the forecasting problem set-up and code
followed by a discussion of the results.</p>
<div class="section level3">
<h3 id="problem-setup">Problem Setup<a class="anchor" aria-label="anchor" href="#problem-setup"></a>
</h3>
<p>Our goal is to predict county-level COVID-19 case incidence rates for
1 and 2 weeks ahead. For this, we restrict our attention to the 442
counties that had at least 200 confirmed cases by May 14, 2020 (the end
of the Google survey data) and in which both the Facebook and Google %
CLI-in-community signals are available.</p>
<p>To set the notation, let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Y_{l,t}</annotation></semantics></math>
denote the smoothed COVID-19 case incidence rate for location (county)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>
and day
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">F_{l,t}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>G</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">G_{l,t}</annotation></semantics></math>
denote the Facebook and Google % CLI-in-community signals, respectively,
for location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>
and time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
Note that we rescale all these signals from their given values in our
API so that they are true proportions. We then evaluate the following
four models:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>+</mo><mi>d</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>≈</mo><mi>α</mi><mo>+</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>2</mn></munderover><msub><mi>β</mi><mi>j</mi></msub><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>+</mo><mi>d</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>≈</mo><mi>α</mi><mo>+</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>2</mn></munderover><msub><mi>β</mi><mi>j</mi></msub><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>2</mn></munderover><msub><mi>γ</mi><mi>j</mi></msub><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>F</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>+</mo><mi>d</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>≈</mo><mi>α</mi><mo>+</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>2</mn></munderover><msub><mi>β</mi><mi>j</mi></msub><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>2</mn></munderover><msub><mi>τ</mi><mi>j</mi></msub><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>G</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>+</mo><mi>d</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>≈</mo><mi>α</mi><mo>+</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>2</mn></munderover><msub><mi>β</mi><mi>j</mi></msub><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>2</mn></munderover><msub><mi>γ</mi><mi>j</mi></msub><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>F</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>2</mn></munderover><msub><mi>τ</mi><mi>j</mi></msub><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>G</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
h(Y_{l,t+d}) &amp;\approx \alpha + \sum_{j = 0}^2 \beta_j h(Y_{l,t-7j}) \\
h(Y_{l,t+d}) &amp;\approx \alpha + \sum_{j = 0}^2 \beta_j h(Y_{l,t-7j}) + \sum_{j = 0}^2 \gamma_j h(F_{l, t-7j}) \\
h(Y_{l,t+d}) &amp;\approx \alpha + \sum_{j = 0}^2 \beta_j h(Y_{l,t-7j}) + \sum_{j = 0}^2 \tau_j h(G_{l, t-7j}) \\
h(Y_{l,t+d}) &amp;\approx \alpha + \sum_{j = 0}^2 \beta_j h(Y_{l,t-7j}) + \sum_{j = 0}^2 \gamma_j h(F_{l, t-7j}) + \sum_{j = 0}^2 \tau_j h(G_{l, t-7j})
\end{align}
</annotation></semantics></math> Here
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>7</mn></mrow><annotation encoding="application/x-tex">d = 7</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>14</mn></mrow><annotation encoding="application/x-tex">d = 14</annotation></semantics></math>
depending on the target value, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>h</mi><annotation encoding="application/x-tex">h</annotation></semantics></math>
is a transformation to be specified later.</p>
<p>We’ll call the first model the “Cases” model because it bases its
predictions of future case rates on COVID-19 case rates (from 0, 1 and 2
weeks back). The second model is called “Cases + Facebook” because it
additionally incorporates the current Facebook signal, and the Facebook
signal from 1 and 2 weeks back. The third model, “Cases + Google”, is
exactly the same as the second but substitutes the Google signal instead
of the Facebook one. The fourth and final model model, “Cases + Facebook
+ Google”, uses both Facebook and Google signals. For each model, we use
our canned autoregressive forecaster with quantile regression to
forecast at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>0</mn></msub><annotation encoding="application/x-tex">t_0</annotation></semantics></math>
(and predict case rates at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mn>0</mn></msub><mo>+</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">t_0 + d</annotation></semantics></math>).
We train over training over all locations,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>
(all 442 counties), and all time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
that are within the most recent 14 days of data available up to and
including time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>0</mn></msub><annotation encoding="application/x-tex">t_0</annotation></semantics></math>.
In other words, we use 14 trailing days for the training set.</p>
<p>The forecasts are denoted by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>Y</mi><mo accent="true">̂</mo></mover><mrow><mi>l</mi><mo>,</mo><msub><mi>t</mi><mn>0</mn></msub><mo>+</mo><mi>d</mi></mrow></msub><annotation encoding="application/x-tex">\hat{Y}_{l, t_0 + d}</annotation></semantics></math>.
To see how accurate these forecasts are, we use the scaled absolute
error:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mrow><mo stretchy="true" form="prefix">|</mo><msub><mover><mi>Y</mi><mo accent="true">̂</mo></mover><mrow><mi>l</mi><mo>,</mo><msub><mi>t</mi><mn>0</mn></msub><mo>+</mo><mi>d</mi></mrow></msub><mo>−</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><msub><mi>t</mi><mn>0</mn></msub><mo>+</mo><mi>d</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><msub><mi>t</mi><mn>0</mn></msub></mrow></msub><mo>−</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><msub><mi>t</mi><mn>0</mn></msub><mo>+</mo><mi>d</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow></mfrac><annotation encoding="application/x-tex">
\frac{| \hat{Y}_{l, t_0 + d} - Y_{l, t_0 + d} |} {| Y_{l, t_0} - Y_{l, t_0 + d} |}
</annotation></semantics></math></p>
<p>where the error in the denominator is the strawman model error. This
model simply uses the most recent case rate for future predictions. You
may recognize this as an application of the flatline forecaster from
<code>epipredict</code>.</p>
<p>We normalize in this manner for two reasons. First, since the scaled
error is the fraction improvement over the strawman’s error, we get an
interpretable scale, where numebrs like 0.8 or 0.9 are favorable, and
numbers like 2 or 5 are increasingly disastrous. Second, in such
problems we should expect considerable county-to-county variability in
the forecasting difficulty. Normalizing by the strawman’s error helps to
adjust for this so that the results on aggregate are not dominated by
the county-to-county differences.</p>
</div>
<div class="section level3">
<h3 id="transformations">Transformations<a class="anchor" aria-label="anchor" href="#transformations"></a>
</h3>
<p>To help stabilize the variance of the case, Facebook and Google data,
we chose to use the logit transformation on their proportions. In
actuality, we use a “padded” version
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mi>x</mi><mo>+</mo><mi>a</mi></mrow><mrow><mn>1</mn><mo>−</mo><mi>x</mi><mo>+</mo><mi>a</mi></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(x) = \log (\frac{x+a}{1-x+a})</annotation></semantics></math>
such that the numerator and denominator are pushed away from zero by a
small constant,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>=</mo><mn>0.01</mn></mrow><annotation encoding="application/x-tex">a = 0.01</annotation></semantics></math>.
An alternative to the logit transform is using a log transform (as in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>+</mo><mi>a</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(x) = \log (x+a)</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
is for padding). Note that such variance-stabilizing transformations are
used in the model fitting. When we calculate the errors, we
back-transform the values for comparison using the inverse transform
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>h</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><annotation encoding="application/x-tex">h^{-1}</annotation></semantics></math>
so that we may calculate them on the original scale.</p>
</div>
<div class="section level3">
<h3 id="forecasting-code">Forecasting Code<a class="anchor" aria-label="anchor" href="#forecasting-code"></a>
</h3>
<p>The code below marches the forecast date
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>0</mn></msub><annotation encoding="application/x-tex">t_0</annotation></semantics></math>
forward, one day at a time for the nine forecasting dates for which the
four models can all be fit (May 6, 2020 to May 14, 2020). Then, it fits
the models, makes predictions 7 and 14 days ahead (as permissible by the
data), and records the errors.</p>
<p>There are a number of benefits to using <code>epipredict</code> over
writing the code from scratch to fit and predict under each of the
models. First, we do not have to reformat the data for input into a
model or concern ourselves with its unique interface. We instead work
under unifying interface to streamline the modelling process. Second, we
avoid having to write our own function to append shift values (leads or
lags). This is done for us under-the-hood in the
<code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code> function. You can see this in the
forecaster output by inspecting the <code><a href="../reference/step_epi_shift.html">step_epi_lag()</a></code> and
<code><a href="../reference/step_epi_shift.html">step_epi_ahead()</a></code> pre-processing steps in the
<code>epi_workflow</code>. Third, we only need one for loop for the
forecast dates (and not a second loop for the different aheads) as we
can easily use <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map()</a></code> with the <code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code>
over the different ahead values, as we’ve done before.</p>
<p>However, there are some trade-offs to bear in mind. For instance,
since we are using a canned arx forecaster, we are not able to easily
modify and add steps such as that for signal transformations to the
pre-processing (this is pre-specified as part of using a canned
forecaster). If we were to code-up our own forecaster under the
<code>epipredict</code> framework, we could easily add steps to re-scale
and transform the signals to our <code>epi_recipe</code>. This would
make the code more succinct and self-contained.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epidatr/" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">case_num</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">as_of_date</span> <span class="op">&lt;-</span> <span class="st">"2020-05-14"</span></span>
<span><span class="va">geo_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"jhu-csse"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"confirmed_cumulative_num"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"county"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"*"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200514</span>, <span class="fl">20200514</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">value</span> <span class="op">&gt;=</span> <span class="va">case_num</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fetch county-level Google and Facebook % CLI-in-community signals, and JHU</span></span>
<span><span class="co"># confirmed case incidence proportion</span></span>
<span><span class="va">start_day</span> <span class="op">&lt;-</span> <span class="st">"2020-04-11"</span></span>
<span><span class="va">end_day</span> <span class="op">&lt;-</span> <span class="st">"2020-09-01"</span></span>
<span></span>
<span><span class="va">goog_sm_cli</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"google-survey"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"smoothed_cli"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"county"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"*"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="va">start_day</span>, <span class="va">end_day</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">geo_values</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>goog <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fb_survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"fb-survey"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"smoothed_hh_cmnty_cli"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"county"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"*"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="va">start_day</span>, <span class="va">end_day</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">geo_values</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>fb <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jhu_7dav_incid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"jhu-csse"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"confirmed_7dav_incidence_prop"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"county"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"*"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="va">start_day</span>, <span class="va">end_day</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">geo_values</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>case <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Find "complete" counties, present in all three data signals at all times</span></span>
<span><span class="va">geo_values_complete</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">goog_sm_cli</span><span class="op">$</span><span class="va">geo_value</span>, <span class="va">fb_survey</span><span class="op">$</span><span class="va">geo_value</span><span class="op">)</span>,</span>
<span>  <span class="va">jhu_7dav_incid</span><span class="op">$</span><span class="va">geo_value</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make one big matrix by joining these three data frames</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">goog_sm_cli</span>, <span class="va">fb_survey</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"time_value"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">jhu_7dav_incid</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"time_value"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">geo_values_complete</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_df.html" class="external-link">as_epi_df</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">a</span> <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">a</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">a</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Sigmd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">a</span> <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">a</span><span class="op">)</span> <span class="op">-</span> <span class="va">a</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#### Parameters #####</span></span>
<span></span>
<span><span class="co"># Transforms to consider, in what follows</span></span>
<span><span class="va">trans</span> <span class="op">&lt;-</span> <span class="va">Logit</span></span>
<span><span class="va">inv_trans</span> <span class="op">&lt;-</span> <span class="va">Sigmd</span></span>
<span></span>
<span><span class="co"># Rescale factors for our signals: bring them all down to proportions (between</span></span>
<span><span class="co"># 0 and 1)</span></span>
<span><span class="va">rescale_f</span> <span class="op">&lt;-</span> <span class="fl">1e-2</span> <span class="co"># Originally a percentage</span></span>
<span><span class="va">rescale_g</span> <span class="op">&lt;-</span> <span class="fl">1e-2</span> <span class="co"># Originally a percentage</span></span>
<span><span class="va">rescale_c</span> <span class="op">&lt;-</span> <span class="fl">1e-5</span> <span class="co"># Originally a count per 100,000 people</span></span>
<span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>  case <span class="op">=</span> <span class="fu">trans</span><span class="op">(</span><span class="va">case</span> <span class="op">*</span> <span class="va">rescale_c</span><span class="op">)</span>,</span>
<span>  fb <span class="op">=</span> <span class="fu">trans</span><span class="op">(</span><span class="va">fb</span> <span class="op">*</span> <span class="va">rescale_f</span><span class="op">)</span>,</span>
<span>  goog <span class="op">=</span> <span class="fu">trans</span><span class="op">(</span><span class="va">goog</span> <span class="op">*</span> <span class="va">rescale_g</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># lead = 7</span></span>
<span><span class="va">leads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span></span>
<span><span class="va">lags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">14</span> <span class="co"># Number of trailing days to use for the training set</span></span>
<span></span>
<span><span class="co"># Nine forecast dates</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-05-06"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-05-14"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># List for storage of results</span></span>
<span><span class="va">out_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">date</span> <span class="op">&lt;-</span> <span class="va">dates</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">date</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2020-05-13"</span>, <span class="st">"2020-05-14"</span><span class="op">)</span><span class="op">)</span> <span class="va">leads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span> <span class="kw">else</span> <span class="va">leads</span> <span class="op">&lt;-</span> <span class="fl">7</span></span>
<span></span>
<span>  <span class="co"># Pre-structuring test data</span></span>
<span>  <span class="va">z_te</span> <span class="op">&lt;-</span> <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>      target_date <span class="op">=</span> <span class="va">time_value</span>,</span>
<span>      target_case <span class="op">=</span> <span class="va">case</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">target_date</span>, <span class="va">target_case</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Strawman model</span></span>
<span>  <span class="va">out_df0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">leads</span>, <span class="op">~</span> <span class="fu"><a href="../reference/flatline_forecaster.html">flatline_forecaster</a></span><span class="op">(</span></span>
<span>    <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">date</span> <span class="op">-</span> <span class="va">.x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">-</span> <span class="va">n</span>, <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">geo_value</span>, <span class="va">case</span><span class="op">)</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"case"</span>,</span>
<span>    args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>      lags <span class="op">=</span> <span class="va">lags</span>,</span>
<span>      ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>      nonneg <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lead <span class="op">=</span> <span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">z_te</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target_date</span> <span class="op">==</span> <span class="op">(</span><span class="va">date</span> <span class="op">+</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>err0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu">inv_trans</span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op">-</span> <span class="fu">inv_trans</span><span class="op">(</span><span class="va">target_case</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">err0</span>, <span class="va">lead</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Cases model</span></span>
<span>  <span class="va">out_df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">leads</span>, <span class="op">~</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>    <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">date</span> <span class="op">-</span> <span class="va">.x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">-</span> <span class="va">n</span>, <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">geo_value</span>, <span class="va">case</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"case"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="st">"case"</span>,</span>
<span>    trainer <span class="op">=</span> <span class="fu"><a href="../reference/quantile_reg.html">quantile_reg</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>      lags <span class="op">=</span> <span class="va">lags</span>,</span>
<span>      ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>      nonneg <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lead <span class="op">=</span> <span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">z_te</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target_date</span> <span class="op">==</span> <span class="op">(</span><span class="va">date</span> <span class="op">+</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>err1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu">inv_trans</span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op">-</span> <span class="fu">inv_trans</span><span class="op">(</span><span class="va">target_case</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">err1</span>, <span class="va">lead</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Cases and Facebook model</span></span>
<span>  <span class="va">out_df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">leads</span>, <span class="op">~</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>    <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">date</span> <span class="op">-</span> <span class="va">.x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">-</span> <span class="va">n</span>, <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">geo_value</span>, <span class="va">case</span>, <span class="va">fb</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"case"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case"</span>, <span class="st">"fb"</span><span class="op">)</span>,</span>
<span>    trainer <span class="op">=</span> <span class="fu"><a href="../reference/quantile_reg.html">quantile_reg</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>      lags <span class="op">=</span> <span class="va">lags</span>,</span>
<span>      ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>      nonneg <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lead <span class="op">=</span> <span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">z_te</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target_date</span> <span class="op">==</span> <span class="op">(</span><span class="va">date</span> <span class="op">+</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>err2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu">inv_trans</span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op">-</span> <span class="fu">inv_trans</span><span class="op">(</span><span class="va">target_case</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">err2</span>, <span class="va">lead</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Cases and Google model</span></span>
<span>  <span class="va">out_df3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">leads</span>, <span class="op">~</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>    <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">date</span> <span class="op">-</span> <span class="va">.x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">-</span> <span class="va">n</span>, <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">geo_value</span>, <span class="va">case</span>, <span class="va">goog</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"case"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case"</span>, <span class="st">"goog"</span><span class="op">)</span>,</span>
<span>    trainer <span class="op">=</span> <span class="fu"><a href="../reference/quantile_reg.html">quantile_reg</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>      lags <span class="op">=</span> <span class="va">lags</span>,</span>
<span>      ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>      nonneg <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lead <span class="op">=</span> <span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">z_te</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target_date</span> <span class="op">==</span> <span class="op">(</span><span class="va">date</span> <span class="op">+</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>err3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu">inv_trans</span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op">-</span> <span class="fu">inv_trans</span><span class="op">(</span><span class="va">target_case</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">err3</span>, <span class="va">lead</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Cases, Facebook and Google model</span></span>
<span>  <span class="va">out_df4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">leads</span>, <span class="op">~</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>    <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">date</span> <span class="op">-</span> <span class="va">.x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">-</span> <span class="va">n</span>, <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">geo_value</span>, <span class="va">case</span>, <span class="va">fb</span>, <span class="va">goog</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"case"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case"</span>, <span class="st">"goog"</span><span class="op">)</span>,</span>
<span>    trainer <span class="op">=</span> <span class="fu"><a href="../reference/quantile_reg.html">quantile_reg</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>      lags <span class="op">=</span> <span class="va">lags</span>,</span>
<span>      ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>      nonneg <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lead <span class="op">=</span> <span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">z_te</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target_date</span> <span class="op">==</span> <span class="op">(</span><span class="va">date</span> <span class="op">+</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>err4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu">inv_trans</span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op">-</span> <span class="fu">inv_trans</span><span class="op">(</span><span class="va">target_case</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">err4</span>, <span class="va">lead</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Left join of the results for all models</span></span>
<span>  <span class="va">out_list</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">out_df0</span>, <span class="va">out_df1</span><span class="op">)</span>, <span class="va">out_df2</span><span class="op">)</span>, <span class="va">out_df3</span><span class="op">)</span>, <span class="va">out_df4</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Outside of loop bind rows of list</span></span>
<span><span class="va">out_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">out_list</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="results-all-four-models">Results: All Four Models<a class="anchor" aria-label="anchor" href="#results-all-four-models"></a>
</h3>
<p>Since there are only two common forecast dates available for the four
models for the 14-day-ahead forecasts (May 13 and May 14, 2020), we skip
studying the 14-day-ahead forecast results in this four-way model
discussion.</p>
<p>Below we compute the median scaled errors for each of the four models
over the 9-day test period. We can see that adding either or both of the
survey signals improves on the median scaled error of the model that
uses cases only, with the biggest gain achieved by the “Cases + Google”
model. We can also see that the median scaled errors are all close to 1
(with all but that from the “Cases + Google” and “Cases + Facebook +
Google” models exceeding 1), which speaks to the difficulty of the
forecasting problem.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"Cases"</span>, <span class="st">"Cases + Facebook"</span>, <span class="st">"Cases + Google"</span>,</span>
<span>  <span class="st">"Cases + Facebook + Google"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate the scaled errors for each model, that is, the error relative to the strawman's error</span></span>
<span><span class="va">res_all4</span> <span class="op">&lt;-</span> <span class="va">out_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># Restrict to common time</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="va">err1</span><span class="op">:</span><span class="va">err4</span>, <span class="op">~</span> <span class="va">.x</span> <span class="op">/</span> <span class="va">err0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># compute relative error to strawman</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="va">err2</span><span class="op">:</span><span class="va">err4</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="op">~</span> <span class="va">err1</span> <span class="op">-</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># relative to cases model</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">err0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate and print median errors, for all 4 models, and just 7 days ahead</span></span>
<span><span class="va">res_err4</span> <span class="op">&lt;-</span> <span class="va">res_all4</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"diff"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    names_to <span class="op">=</span> <span class="st">"model"</span>, values_to <span class="op">=</span> <span class="st">"err"</span>,</span>
<span>    cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">lead</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    lead <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">lead</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">leads</span>, <span class="st">"days ahead"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">model</span>, labels <span class="op">=</span> <span class="va">model_names</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>  <span class="va">res_err4</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">lead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>err <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">err</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">forecast_date</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">lead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>      <span class="st">"Model"</span> <span class="op">=</span> <span class="va">model</span>, <span class="st">"Median scaled error"</span> <span class="op">=</span> <span class="va">err</span>,</span>
<span>      <span class="st">"Target"</span> <span class="op">=</span> <span class="va">lead</span>, <span class="st">"Test days"</span> <span class="op">=</span> <span class="va">n</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Target</span> <span class="op">==</span> <span class="st">"7 days ahead"</span><span class="op">)</span>,</span>
<span>  caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>    <span class="st">"Test period:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">res_err4</span><span class="op">$</span><span class="va">forecast_date</span><span class="op">)</span>, <span class="st">"to"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">res_err4</span><span class="op">$</span><span class="va">forecast_date</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  format <span class="op">=</span> <span class="st">"html"</span>, table.attr <span class="op">=</span> <span class="st">"style='width:70%;'"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table style="width:70%;" class="table">
<caption>
Test period: 2020-05-06 to 2020-05-14
</caption>
<thead><tr>
<th style="text-align:left;">
Model
</th>
<th style="text-align:left;">
Target
</th>
<th style="text-align:right;">
Median scaled error
</th>
<th style="text-align:right;">
Test days
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Cases
</td>
<td style="text-align:left;">
7 days ahead
</td>
<td style="text-align:right;">
1.0126408
</td>
<td style="text-align:right;">
9
</td>
</tr>
<tr>
<td style="text-align:left;">
Cases + Facebook
</td>
<td style="text-align:left;">
7 days ahead
</td>
<td style="text-align:right;">
1.0075064
</td>
<td style="text-align:right;">
9
</td>
</tr>
<tr>
<td style="text-align:left;">
Cases + Google
</td>
<td style="text-align:left;">
7 days ahead
</td>
<td style="text-align:right;">
0.9664556
</td>
<td style="text-align:right;">
9
</td>
</tr>
<tr>
<td style="text-align:left;">
Cases + Facebook + Google
</td>
<td style="text-align:left;">
7 days ahead
</td>
<td style="text-align:right;">
0.9970219
</td>
<td style="text-align:right;">
9
</td>
</tr>
</tbody>
</table>
<p><span class="math display">$$\\[0.01in]$$</span> Are these
differences in median scaled errors significant? Some basic hypothesis
testing suggests that some probably are: Below we conduct a sign test
for whether the difference in the “Cases” model’s scaled error and each
other model’s scaled error is centered at zero. The sign test is run on
the 9 test days x 442 counties = 3978 pairs of scaled errors. The
p-value from the “Cases” versus “Cases + Google” test is tiny and well
below a cutoff of 0.01. In contrast, the p-values from the “Cases”
versus “Cases + Facebook” and the “Cases” versus “Cases + Facebook +
Google” tests are much bigger and exceed this cutoff, suggesting that
the Facebook survey is not adding as much for this situation (meaning
the time and ahead considered, etc.)</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute p-values using the sign test against a one-sided alternative, for</span></span>
<span><span class="co"># all models, and just 7 days ahead</span></span>
<span><span class="va">res_dif4</span> <span class="op">&lt;-</span> <span class="va">res_all4</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    names_to <span class="op">=</span> <span class="st">"model"</span>, values_to <span class="op">=</span> <span class="st">"diff"</span>,</span>
<span>    cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">lead</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    lead <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">lead</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">leads</span>, <span class="st">"days ahead"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">model</span>,</span>
<span>      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"Cases vs Cases + Facebook"</span>,</span>
<span>        <span class="st">"Cases vs Cases + Google"</span>,</span>
<span>        <span class="st">"Cases vs Cases + Facebook + Google"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>  <span class="va">res_dif4</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">lead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html" class="external-link">binom.test</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">diff</span> <span class="op">&gt;</span> <span class="fl">0</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, alt <span class="op">=</span> <span class="st">"greater"</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">p.val</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">lead</span> <span class="op">==</span> <span class="st">"7 days ahead"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"Comparison"</span> <span class="op">=</span> <span class="va">model</span>, <span class="st">"Target"</span> <span class="op">=</span> <span class="va">lead</span>, <span class="st">"P-value"</span> <span class="op">=</span> <span class="va">p</span><span class="op">)</span>,</span>
<span>  format <span class="op">=</span> <span class="st">"html"</span>, table.attr <span class="op">=</span> <span class="st">"style='width:50%;'"</span>,</span>
<span>  digiits <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table style="width:50%;" class="table">
<thead><tr>
<th style="text-align:left;">
Comparison
</th>
<th style="text-align:left;">
Target
</th>
<th style="text-align:right;">
P-value
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Cases vs Cases + Facebook
</td>
<td style="text-align:left;">
7 days ahead
</td>
<td style="text-align:right;">
0.3065796
</td>
</tr>
<tr>
<td style="text-align:left;">
Cases vs Cases + Google
</td>
<td style="text-align:left;">
7 days ahead
</td>
<td style="text-align:right;">
0.0000225
</td>
</tr>
<tr>
<td style="text-align:left;">
Cases vs Cases + Facebook + Google
</td>
<td style="text-align:left;">
7 days ahead
</td>
<td style="text-align:right;">
0.2291932
</td>
</tr>
</tbody>
</table>
<p><span class="math display">$$\\[0.01in]$$</span> We should take these
test results with a grain of salt because the sign test assumes
independence of observations, which clearly cannot be true given the
spatiotemporal structure of our forecasting problem. To mitigate the
dependence across time (which intuitively seems to matter more than that
across space), we recomputed these tests in a stratified way, where for
each day we run a sign test on the scaled errors between two models over
all 442 counties. The results are plotted as histograms below; the
“Cases + Google” and (to a lesser extent) the “Cases + Facebook +
Google” models appear to deliver some decently small p-values, but this
is not very evident with the “Cases + Facebook” model. Taking a larger
sample size (of more than nine test days) would be a natural next step
to take to see if these results persist.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Red, blue (similar to ggplot defaults), then yellow</span></span>
<span><span class="va">ggplot_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#FC4E07"</span>, <span class="st">"#00AFBB"</span>, <span class="st">"#E7B800"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">res_dif4</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">lead</span>, <span class="va">forecast_date</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html" class="external-link">binom.test</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">diff</span> <span class="op">&gt;</span> <span class="fl">0</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, alt <span class="op">=</span> <span class="st">"greater"</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">p.val</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">lead</span> <span class="op">==</span> <span class="st">"7 days ahead"</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">model</span>, fill <span class="op">=</span> <span class="va">model</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">ggplot_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">ggplot_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">lead</span>, <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"P-value"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="symptom-surveys_files/figure-html/unnamed-chunk-4-1.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="results-first-two-models">Results: First Two Models<a class="anchor" aria-label="anchor" href="#results-first-two-models"></a>
</h3>
<p>One way to get a larger sample size with the current data is to
compare a subset of the models. Therefore, next we focus on comparing
results between the “Cases” and “Cases + Facebook” models only.
Restricting to common forecast dates for these two models yields a much
longer test period for the 7 and 14-day-ahead forecasts: May 20 through
August 27, 2020. We make the code to compare these two models a simple
function so that we have the option to use it over different dates or
aheads (in particular, this function will be useful for the next section
where we explore several ahead values):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">case_fb_mods</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">forecast_dates</span>, <span class="va">leads</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># List for storage of results</span></span>
<span>  <span class="va">out_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">forecast_dates</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">forecast_dates</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">date</span> <span class="op">&lt;-</span> <span class="va">forecast_dates</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co"># Pre-structuring test data</span></span>
<span>    <span class="va">z_te</span> <span class="op">&lt;-</span> <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>        target_date <span class="op">=</span> <span class="va">time_value</span>,</span>
<span>        target_case <span class="op">=</span> <span class="va">case</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">target_date</span>, <span class="va">target_case</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Strawman model</span></span>
<span>    <span class="va">out_df0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">leads</span>, <span class="op">~</span> <span class="fu"><a href="../reference/flatline_forecaster.html">flatline_forecaster</a></span><span class="op">(</span></span>
<span>      <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">date</span> <span class="op">-</span> <span class="va">.x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">-</span> <span class="va">n</span>, <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">geo_value</span>, <span class="va">case</span><span class="op">)</span>,</span>
<span>      outcome <span class="op">=</span> <span class="st">"case"</span>,</span>
<span>      args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>        lags <span class="op">=</span> <span class="va">lags</span>,</span>
<span>        ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>        nonneg <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lead <span class="op">=</span> <span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">z_te</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target_date</span> <span class="op">==</span> <span class="op">(</span><span class="va">date</span> <span class="op">+</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>err0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu">inv_trans</span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op">-</span> <span class="fu">inv_trans</span><span class="op">(</span><span class="va">target_case</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">err0</span>, <span class="va">lead</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Cases model</span></span>
<span>    <span class="va">out_df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">leads</span>, <span class="op">~</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>      <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">date</span> <span class="op">-</span> <span class="va">.x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">-</span> <span class="va">n</span>, <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">geo_value</span>, <span class="va">case</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      outcome <span class="op">=</span> <span class="st">"case"</span>,</span>
<span>      predictors <span class="op">=</span> <span class="st">"case"</span>,</span>
<span>      trainer <span class="op">=</span> <span class="fu"><a href="../reference/quantile_reg.html">quantile_reg</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>        lags <span class="op">=</span> <span class="va">lags</span>,</span>
<span>        ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>        nonneg <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lead <span class="op">=</span> <span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">z_te</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target_date</span> <span class="op">==</span> <span class="op">(</span><span class="va">date</span> <span class="op">+</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>err1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu">inv_trans</span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op">-</span> <span class="fu">inv_trans</span><span class="op">(</span><span class="va">target_case</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">err1</span>, <span class="va">lead</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Cases and Facebook model</span></span>
<span>    <span class="va">out_df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">leads</span>, <span class="op">~</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>      <span class="va">z</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">date</span> <span class="op">-</span> <span class="va">.x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">-</span> <span class="va">n</span>, <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time_value</span>, <span class="va">geo_value</span>, <span class="va">case</span>, <span class="va">fb</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      outcome <span class="op">=</span> <span class="st">"case"</span>,</span>
<span>      predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case"</span>, <span class="st">"fb"</span><span class="op">)</span>,</span>
<span>      trainer <span class="op">=</span> <span class="fu"><a href="../reference/quantile_reg.html">quantile_reg</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>        lags <span class="op">=</span> <span class="va">lags</span>,</span>
<span>        ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>        nonneg <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lead <span class="op">=</span> <span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">z_te</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target_date</span> <span class="op">==</span> <span class="op">(</span><span class="va">date</span> <span class="op">+</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>err2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu">inv_trans</span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op">-</span> <span class="fu">inv_trans</span><span class="op">(</span><span class="va">target_case</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">err2</span>, <span class="va">lead</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Left join of the results for all models</span></span>
<span>    <span class="va">out_list</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">out_df0</span>, <span class="va">out_df1</span><span class="op">)</span>, <span class="va">out_df2</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># Outside of loop bind rows and split into two lists by lead</span></span>
<span>  <span class="va">out_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">out_list</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Choose forecast dates common to the Cases and Cases + Facebook models</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-05-20"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-08-27"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Two leads to consider</span></span>
<span><span class="va">leads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">case_fb_mods</span><span class="op">(</span><span class="va">dates</span>, <span class="va">leads</span><span class="op">)</span></span></code></pre></div>
<p>The median scaled errors over the test period are computed and
reported below. Now we see a decent improvement in median scaled error
for the “Cases + Facebook” model, which is true for both 7-day-ahead and
14-day-ahead forecasts.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For just models 1 and 2, then calculate the scaled</span></span>
<span><span class="co"># errors, that is, the error relative to the strawman's error</span></span>
<span><span class="va">res_all2</span> <span class="op">&lt;-</span> <span class="va">res</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># Restrict to common time</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="va">err1</span><span class="op">:</span><span class="va">err2</span>, <span class="op">~</span> <span class="va">.x</span> <span class="op">/</span> <span class="va">err0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># compute relative error to strawman</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>err12_diff <span class="op">=</span> <span class="va">err1</span> <span class="op">-</span> <span class="va">err2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># Compute differences</span></span>
<span>  <span class="co"># relative to cases model</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">err0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate and print median errors, for just models 1 and 2, and both 7 and 14</span></span>
<span><span class="co"># days ahead</span></span>
<span><span class="va">res_err2</span> <span class="op">&lt;-</span> <span class="va">res_all2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"diff"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    names_to <span class="op">=</span> <span class="st">"model"</span>, values_to <span class="op">=</span> <span class="st">"err"</span>,</span>
<span>    cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">lead</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    lead <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">lead</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">leads</span>, <span class="st">"days ahead"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">model</span>, labels <span class="op">=</span> <span class="va">model_names</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>  <span class="va">res_err2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"diff"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">lead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>err <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">err</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">forecast_date</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">lead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>      <span class="st">"Model"</span> <span class="op">=</span> <span class="va">model</span>, <span class="st">"Median scaled error"</span> <span class="op">=</span> <span class="va">err</span>,</span>
<span>      <span class="st">"Target"</span> <span class="op">=</span> <span class="va">lead</span>, <span class="st">"Test days"</span> <span class="op">=</span> <span class="va">n</span></span>
<span>    <span class="op">)</span>,</span>
<span>  caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>    <span class="st">"Test period:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">res_err2</span><span class="op">$</span><span class="va">forecast_date</span><span class="op">)</span>, <span class="st">"to"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">res_err2</span><span class="op">$</span><span class="va">forecast_date</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  format <span class="op">=</span> <span class="st">"html"</span>, table.attr <span class="op">=</span> <span class="st">"style='width:70%;'"</span>, digits <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table style="width:70%;" class="table">
<caption>
Test period: 2020-05-20 to 2020-08-25
</caption>
<thead><tr>
<th style="text-align:left;">
Model
</th>
<th style="text-align:left;">
Target
</th>
<th style="text-align:right;">
Median scaled error
</th>
<th style="text-align:right;">
Test days
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Cases
</td>
<td style="text-align:left;">
7 days ahead
</td>
<td style="text-align:right;">
0.952
</td>
<td style="text-align:right;">
98
</td>
</tr>
<tr>
<td style="text-align:left;">
Cases + Facebook
</td>
<td style="text-align:left;">
7 days ahead
</td>
<td style="text-align:right;">
0.932
</td>
<td style="text-align:right;">
98
</td>
</tr>
<tr>
<td style="text-align:left;">
Cases
</td>
<td style="text-align:left;">
14 days ahead
</td>
<td style="text-align:right;">
1.010
</td>
<td style="text-align:right;">
91
</td>
</tr>
<tr>
<td style="text-align:left;">
Cases + Facebook
</td>
<td style="text-align:left;">
14 days ahead
</td>
<td style="text-align:right;">
0.989
</td>
<td style="text-align:right;">
91
</td>
</tr>
</tbody>
</table>
<p><span class="math display">$$\\[0.01in]$$</span></p>
<p>Thanks to the extended length of the test period, we can also plot
the trajectories of the median scaled errors over time, as we do below,
with the left plot concerning 7-day-ahead forecasts, and the right
14-day-ahead forecasts. These plots reveal something at once interesting
and bothersome: the median scaled errors are quite volatile over time,
and for some periods in July, forecasting became much harder, with the
scaled errors reaching above 1.5 for 7-day-ahead forecasts, and above
1.8 for 14-day-ahead forecasts. Furthermore, we can see a clear visual
difference between the median scaled errors from the “Cases + Facebook”
model in red and the “Cases” model in black. The former appears to be
below the latter during periods with low median scaled errors and above
during periods where forecasting becomes hard and the scaled errors
shoot above 1. This suggests that the Facebook signal may be more useful
to incorporate during periods of time where forecasting is easier.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot median errors as a function of time, for models 1 and 2, and both 7 and</span></span>
<span><span class="co"># 14 days ahead</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">res_err2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">lead</span>, <span class="va">forecast_date</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>err <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">err</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">forecast_date</span>, y <span class="op">=</span> <span class="va">err</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="va">ggplot_colors</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">lead</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Median scaled error"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="symptom-surveys_files/figure-html/unnamed-chunk-7-1.png" width="100%"></p>
<p>The fact that the lines are non-coincident suggests that the results
we’re seeing here are likely to be significantly different, though it’s
hard to say definitively given the complicated dependence structure
present in the data. Below we perform a sign test for whether the
difference in scaled errors from the “Cases” and “Cases + Facebook”
models is centered at zero. The p-values are essentially zero, given the
large sample sizes: 98 test days in total for the 7-day-ahead forecasts
and 91 days for the 14-day-ahead forecasts (times 442 counties for each
day).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute p-values using the sign test against a one-sided alternative, just</span></span>
<span><span class="co"># for models 1 and 2, and both 7 and 14 days ahead</span></span>
<span><span class="va">res_dif2</span> <span class="op">&lt;-</span> <span class="va">res_all2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    names_to <span class="op">=</span> <span class="st">"model"</span>, values_to <span class="op">=</span> <span class="st">"diff"</span>,</span>
<span>    cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">lead</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    lead <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">lead</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">leads</span>, <span class="st">"days ahead"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">model</span>, labels <span class="op">=</span> <span class="st">"Cases &gt; Cases + Facebook"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>  <span class="va">res_dif2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">lead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html" class="external-link">binom.test</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">diff</span> <span class="op">&gt;</span> <span class="fl">0</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, alt <span class="op">=</span> <span class="st">"greater"</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">p.val</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"Comparison"</span> <span class="op">=</span> <span class="va">model</span>, <span class="st">"Target"</span> <span class="op">=</span> <span class="va">lead</span>, <span class="st">"P-value"</span> <span class="op">=</span> <span class="va">p</span><span class="op">)</span>,</span>
<span>  format <span class="op">=</span> <span class="st">"html"</span>, table.attr <span class="op">=</span> <span class="st">"style='width:50%;'"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table style="width:50%;" class="table">
<thead><tr>
<th style="text-align:left;">
Comparison
</th>
<th style="text-align:left;">
Target
</th>
<th style="text-align:right;">
P-value
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Cases &gt; Cases + Facebook
</td>
<td style="text-align:left;">
7 days ahead
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
Cases &gt; Cases + Facebook
</td>
<td style="text-align:left;">
14 days ahead
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
<p><span class="math display">$$\\[0.01in]$$</span></p>
<p>If we stratify and recompute p-values by forecast date, the bulk of
p-values are quite small.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">res_dif2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">lead</span>, <span class="va">forecast_date</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html" class="external-link">binom.test</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">diff</span> <span class="op">&gt;</span> <span class="fl">0</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, alt <span class="op">=</span> <span class="st">"greater"</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">p.val</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">model</span>, fill <span class="op">=</span> <span class="va">model</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">ggplot_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">ggplot_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">lead</span>, <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"P-value"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="symptom-surveys_files/figure-html/unnamed-chunk-9-1.png" width="100%"></p>
<p>This exploration illustrates an important point: The test period
should be chosen so that it is large enough in size to see differences
(if there are any) between the models under comparison. While we did not
observe significant differences between the “Cases” and “Cases +
Facebook” models when the test period was small at 9 days, we did
observe a significant difference over this extended test period of
nearly 100 days.</p>
</div>
<div class="section level3">
<h3 id="varying-the-number-of-days-ahead">Varying the Number of Days Ahead<a class="anchor" aria-label="anchor" href="#varying-the-number-of-days-ahead"></a>
</h3>
<p>Statistical significance refers to whether an effect exists (as
opposed to occurring by chance), while practical significance refers to
the magnitude of the effect and whether it is meaningful in the real
world. Hypothesis tests, such as the sign tests we conducted above, tell
us whether the differences in errors are statistically significant, but
not about their practical significance. For example, for 7-day-ahead
forecasts, what does an improvement of 0.019 units on the scaled error
scale really mean, when comparing the “Cases + Facebook” model to the
“Cases” model? Is this a meaningful gain in practice?</p>
<p>To answer questions such as these, we can look at the way that the
median scaled errors behave as a function of the number of days ahead.
Previously, we considered forecasting case rates just 7 and 14 days
ahead. Now we will systematically examine 5 through 20 days ahead (the
key difference in the code being that we use <code>leads = 5:20</code>).
Note that running the code for this many leads may take a while.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Consider a number of leads</span></span>
<span><span class="va">leads</span> <span class="op">&lt;-</span> <span class="fl">5</span><span class="op">:</span><span class="fl">20</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">case_fb_mods</span><span class="op">(</span><span class="va">dates</span>, <span class="va">leads</span><span class="op">)</span></span></code></pre></div>
<p>We obtain and plot the median scaled errors for the “Cases” and
“Cases + Facebook” models for different number of days ahead for the
forecast target. This is done over May 20 through August 27 for the
forecast dates that are common to the two models.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">err_by_lead</span> <span class="op">&lt;-</span> <span class="va">res</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># Restrict to common time</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="va">err1</span><span class="op">:</span><span class="va">err2</span>, <span class="op">~</span> <span class="va">.x</span> <span class="op">/</span> <span class="va">err0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">err0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    names_to <span class="op">=</span> <span class="st">"model"</span>, values_to <span class="op">=</span> <span class="st">"err"</span>,</span>
<span>    cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">lead</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">model</span>, labels <span class="op">=</span> <span class="va">model_names</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">lead</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>err <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">err</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">err_by_lead</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lead</span>, y <span class="op">=</span> <span class="va">err</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="va">ggplot_colors</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span></span>
<span>    yintercept <span class="op">=</span> <span class="va">err_by_lead</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">lead</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">7</span>, <span class="va">model</span> <span class="op">==</span> <span class="st">"Cases"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">err</span><span class="op">)</span>,</span>
<span>    linetype <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"gray"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Forecasting errors by number of days ahead"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>      <span class="st">"Over all counties with at least %i cumulative cases"</span>,</span>
<span>      <span class="va">case_num</span></span>
<span>    <span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Number of days ahead"</span>, y <span class="op">=</span> <span class="st">"Median scaled error"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># + theme(legend.position = "bottom", legend.title = element_blank())</span></span></code></pre></div>
<p><img src="symptom-surveys_files/figure-html/unnamed-chunk-11-1.png" width="100%"></p>
<p>A first glance shows that the “Cases + Facebook” model, in red, gives
better median scaled errors at all ahead values. Furthermore, the
vertical gap between the two curves is consistently in the range of what
we were seeing before (for 7 and 14 days ahead), around 0.02 units on
the scaled error scale.</p>
<p>But if we look at this from a different angle, by considering the
horizontal gap between the curves, then we can infer something quite a
bit more interesting: For 7-day-ahead forecasts, the median scaled error
of the “Cases” model (indicated by the horizontal gray line) is
comparable to that of 12-day-ahead forecasts from the “Cases + Facebook”
model. So using the % CLI-in-community signal from our Facebook survey
buys us around 4 extra days of lead time for this forecasting problem,
which is striking. As you might imagine, different forecast targets
yield different lead times (for 14-day-ahead forecasts, it appears to be
around 2 to 3 days of lead time), but the added value of the survey
signal is clear throughout.</p>
</div>
<div class="section level3">
<h3 id="wrap-up">Wrap-Up<a class="anchor" aria-label="anchor" href="#wrap-up"></a>
</h3>
<p>In this vignette, we’ve shown that either of the Facebook or Google %
CLI-in-community signals can improve the accuracy of short-term
forecasts of county-level COVID-19 case rates. The significance of these
improvements is more apparent with the Facebook signal, thanks to the
much larger test period. With either signal, the magnitude of the
improvement offered seems modest but nontrivial, especially because the
forecasting problem is so difficult in the first place.</p>
<p>We reiterate that this was just a demo. Our analysis was fairly
simple and lacks a few qualities that we’d expect in a truly
comprehensive, realistic forecasting analysis. For reflection, let’s
discuss three possible areas to improve:</p>
<ol style="list-style-type: decimal">
<li><p>The models we considered are simple autoregressive structures
from standard time series and could be improved in various ways
(including, considering other relevant dimensions like mobility
measures, county health metrics, etc.).</p></li>
<li><p>The forecasts we produced are point rather than distributional
forecasts. That is, we predict a single number, rather than an entire
distribution for what happens 7 and 14 days ahead. Distributional
forecasts portray uncertainty in a transparent way, which is important
in practice.</p></li>
<li><p>The way we trained our forecast models does not account for data
latency and revisions, which are critical issues. For each
(retrospective) forecast date,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>0</mn></msub><annotation encoding="application/x-tex">t_0</annotation></semantics></math>,
we constructed forecasts by training on data that we fetched from the
API today, “as of” the day of writing this, and not “as of” the forecast
date. This matters because nearly all signals are subject to latency and
go through multiple revisions.</p></li>
</ol>
<p>On the flip side, our example here was not that far away from being
realistic. The models we examined are actually not too different from
Delphi’s forecasters in production. Also, the way we fit the quantile
regression models in the code extends immediately to multiple quantile
regression (this just requires changing the parameter
<code>quantile_levels</code> in the call to
<code><a href="../reference/quantile_reg.html">quantile_reg()</a></code>). And lastly, it’s fairly easy to change the
data acquisition step in the code so that data gets pulled “as of” the
forecast date (this requires specifying the parameter <code>as_of</code>
in the call to <code><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast()</a></code> and should change per
forecast date).</p>
<p>Hopefully these preliminary findings have gotten you excited about
the possible uses of this symptom survey data. For further practice, try
your hand at implementing the suggested improvements or develop your own
novel analytic approach to extract insights from this data.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel J. McDonald, Ryan Tibshirani, Dmitry Shemetov, David Weber, CMU’s Delphi Research Group, Logan Brooks, Rachel Lobay.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
